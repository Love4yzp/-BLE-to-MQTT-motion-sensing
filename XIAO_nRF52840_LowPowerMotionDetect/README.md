# XIAO nRF52840 低功耗运动检测传感器

BTHome 协议运动检测传感器，用于智慧零售场景。

## 快速配置

编辑 `config.h`：

```c
#define SENSITIVITY_PRESET  2    // 0=高级, 1=高灵敏, 2=标准, 3=低灵敏
#define DEBUG_ENABLED  0         // 0=生产, 1=调试
```

| 预设 | 触发条件 | 适用场景 | 续航 (200次/天) |
|------|----------|----------|-----------------|
| 1 高灵敏 | 轻触即触发 | 小件/轻便商品 | ~6 个月 |
| 2 标准 | 正常拿起 | 大多数商品 | ~10 个月 |
| 3 低灵敏 | 需用力拿起 | 震动环境/重型商品 | ~12+ 个月 |
| 0 高级 | 自定义 | 需要微调的场景 | 取决于配置 |

### 高级模式 (SENSITIVITY_PRESET = 0)

当预设 1-3 无法满足需求时，设置 `SENSITIVITY_PRESET = 0` 并调整以下参数：

```c
#define SENSITIVITY_PRESET   0       // 启用高级模式

#define CUSTOM_THRESHOLD     0x0A    // 运动阈值 (0x02~0x3F)
#define CUSTOM_TAIL_WINDOW   3000    // 尾随窗口 (ms)
#define CUSTOM_TX_POWER      4       // 发射功率 (dBm)
```

**参数说明：**

| 参数 | 范围 | 说明 |
|------|------|------|
| CUSTOM_THRESHOLD | 0x02~0x3F | 越小越灵敏，公式: 阈值 = 值 × 31.25mg |
| CUSTOM_TAIL_WINDOW | 1000~10000 | 广播后等待时间(ms)，越长越耗电 |
| CUSTOM_TX_POWER | -40 ~ +4 | 发射功率(dBm)，越高覆盖越远但更耗电 |

---

## 功耗影响因素

### 触发频率（最主要因素）

| 每日触发次数 | CR2032 续航 |
|--------------|-------------|
| 50 次 | 1.5+ 年 |
| 200 次 | 8-12 个月 |
| 500 次 | 4-6 个月 |
| 1000 次 | 2-3 个月 |

> **关键**：误触发会显著缩短电池寿命。震动环境务必使用低灵敏度预设。

### 功耗状态

| 状态 | 电流 | 说明 |
|------|------|------|
| 深度睡眠 | < 5 µA | 99% 时间处于此状态 |
| BLE 广播 | ~3 mA | 每次触发约 300ms |
| 尾随窗口 | ~0.5 mA | 等待连续动作，最长 2-4 秒 |

### 环境因素

| 因素 | 影响 | 建议 |
|------|------|------|
| 低温 (<0°C) | 电池容量↓ 30-50% | 避免冷库环境 |
| 高温 (>45°C) | 电池寿命缩短 | 避免阳光直射 |
| 震动源附近 | 误触发↑ | 使用低灵敏度 |

---

## 通信质量影响因素

### 网关距离

| 距离 | 遮挡情况 | 信号质量 |
|------|----------|----------|
| < 5m | 无遮挡 | ★★★ 优秀 |
| 5-15m | 无遮挡 | ★★☆ 良好 |
| 5-10m | 有人/货架 | ★★☆ 良好 |
| > 15m | 任意 | ★☆☆ 较差 |
| 任意 | 金属遮挡 | ★☆☆ 较差 |

### 发射功率

| 预设 | TX Power | 覆盖范围 |
|------|----------|----------|
| 1, 2 | +4 dBm | ~30m（开阔）|
| 3 | 0 dBm | ~15m（省电）|

### 干扰源

| 干扰源 | 影响程度 | 建议 |
|--------|----------|------|
| WiFi 路由器 | 中 | 保持 >1m 距离 |
| 微波炉运行中 | 高 | 避免同时工作 |
| 金属货架 | 中 | 传感器朝向网关 |
| 密集 BLE 设备 | 低 | 通常可忽略 |

### 广播可靠性

固件已优化：
- 广播时长 300ms（足够网关扫描到）
- 快速广播间隔 20ms（提高被捕获概率）
- 尾随窗口合并连续动作（避免重复唤醒）

---

## 故障排查

### 传感器不触发
1. 检查电池（更换测试）
2. 尝试更高灵敏度预设
3. 观察 LED：绿色闪烁=正常启动

### 触发但网关收不到
1. 确认网关距离 < 15m
2. 检查金属遮挡
3. 启用 `DEBUG_ENABLED=1` 查看串口

### 误触发频繁
1. 切换到低灵敏度预设 (3)
2. 检查安装位置震动源
3. 确保传感器固定牢固

### LED 含义

| LED | 行为 | 含义 |
|-----|------|------|
| 绿灯短闪 | 启动时 | 正常唤醒 |
| 蓝灯闪 3 次 | 睡眠前 | 即将进入深度睡眠 |
| 蓝灯持续闪 | 启动时 | IMU 初始化失败 |

---

## 电池更换

- **预期寿命**：6-12 个月（取决于触发频率）
- **更换后**：无需重新配对，MAC 地址不变
- **建议**：记录安装日期，定期批量更换

---

## 技术规格

| 项目 | 规格 |
|------|------|
| MCU | nRF52840 |
| IMU | LSM6DS3 (板载) |
| 协议 | BTHome v2 (0xFCD2) |
| 电池 | CR2032 (220mAh) |
| 睡眠功耗 | < 5 µA |
| 广播功耗 | ~3 mA |
| 工作温度 | -20°C ~ +60°C |

---

## 开发相关

### 编译环境

1. Arduino IDE + Seeed nRF52 开发板包
2. 依赖库：`Seeed Arduino LSM6DS3`

### 开发板选择

```
工具 → 开发板 → Seeed nRF52 Boards → Seeed XIAO nRF52840
```

### BTHome 数据格式

| 字段 | 值 | 说明 |
|------|-----|------|
| UUID | 0xFCD2 | BTHome 服务 |
| Device Info | 0x44 | 触发型设备 |
| Object ID | 0x21 | 二进制运动 |
| Value | 0x01 | 检测到运动 |
