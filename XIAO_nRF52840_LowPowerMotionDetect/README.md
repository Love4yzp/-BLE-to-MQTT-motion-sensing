# XIAO nRF52840 低功耗运动检测传感器

BTHome 协议运动检测传感器，用于智慧零售场景。

---

## 工作原理与架构

### 术语说明

| 术语 | 英文 | 含义 |
|------|------|------|
| **深度睡眠** | System OFF | MCU 完全关闭，仅 IMU 监测运动，功耗 < 5µA |
| **唤醒** | Wake-up | IMU 检测到运动，触发 MCU 重启 |
| **广播** | Advertising | 通过 BLE 发送 motion=1 信号，网关可接收 |
| **尾随窗口** | Tail Window | 广播结束后的等待期，用于检测连续动作 |
| **运动阈值** | Wake-up Threshold | IMU 触发唤醒所需的最小加速度 |

### 状态机架构图

```
                         ┌─────────────────────────────────────────────────────────┐
                         │                    深度睡眠 (System OFF)                  │
                         │                      功耗: < 5 µA                        │
                         │               IMU 以 26Hz 监测加速度变化                   │
                         │                                                         │
                         │  ┌─────────────────────────────────────────────────┐    │
                         │  │ 运动阈值 (THRESHOLD)                             │    │
                         │  │ 默认: 0x0A (~312mg)                             │    │
                         │  │ 范围: 0x02(灵敏) ~ 0x3F(迟钝)                    │    │
                         │  └─────────────────────────────────────────────────┘    │
                         └───────────────────────────┬─────────────────────────────┘
                                                     │
                                                     │ 加速度 > 阈值
                                                     │ (检测到运动)
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────┐
│                              MCU 唤醒 & 初始化                                      │
│                                                                                    │
│  1. 初始化 BLE                                                                     │
│  2. 绿灯短闪 (30ms)                                                                │
│  3. 开始广播 motion=1                                                              │
└────────────────────────────────────────────────────┬───────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────┐
│                              广播状态 (Advertising)                                 │
│                                功耗: ~3 mA                                         │
│                                                                                    │
│  ┌─────────────────────────────────────────────────┐                               │
│  │ 广播时长 (BROADCAST_DURATION)                    │                               │
│  │ 固定: 300ms                                     │                               │
│  │ 广播间隔: 20ms (快速模式)                        │                               │
│  └─────────────────────────────────────────────────┘                               │
│                                                                                    │
│  [每 10ms 检查一次]                                                                 │
│  - 如果检测到新运动 → 重置广播计时器，继续广播                                        │
│  - 如果广播时长已过 → 停止 BLE，进入尾随窗口                                          │
└────────────────────────────────────────────────────┬───────────────────────────────┘
                                                     │
                                                     │ 广播 300ms 完成
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────┐
│                              尾随窗口 (Tail Window)                                 │
│                               功耗: ~0.5 mA                                        │
│                                                                                    │
│  ┌─────────────────────────────────────────────────┐                               │
│  │ 尾随窗口时长 (TAIL_WINDOW)                       │                               │
│  │ 默认: 3000ms (3秒)                              │                               │
│  │ 范围: 1000~10000ms                              │                               │
│  └─────────────────────────────────────────────────┘                               │
│                                                                                    │
│  目的: 合并连续动作，避免频繁睡眠/唤醒                                                │
│                                                                                    │
│  [每 10ms 检查一次]                                                                 │
│  - 如果检测到新运动 → 重新广播，重置所有计时器 ──────────────────┐                    │
│  - 如果尾随窗口时间已过 → 进入睡眠                               │                    │
└──────────────────────────────────────┬─────────────────────────│────────────────────┘
                                       │                         │
                                       │ 无运动超过 3 秒           │ 检测到新运动
                                       ▼                         │
┌──────────────────────────────────────────────────────┐         │
│              进入睡眠 (Go to Sleep)                   │         │
│                                                      │         │
│  1. 停止 BLE 广播                                     │         │
│  2. 蓝灯短闪 (50ms)                                   │         │
│  3. 配置 IMU 唤醒中断                                 │         │
│  4. 清除待处理中断                                    │         │
│  5. 进入 System OFF (~70ms 完成)                      │         │
└──────────────────────────────────────┬───────────────┘         │
                                       │                         │
                                       │                         │
                                       ▼                         │
                              返回深度睡眠 ◄──────────────────────┘
```

### 时序示例

**场景 1：单次拿起放下**
```
时间轴: 0ms ──────────────────────────────────────────────────► 3400ms

[0ms]     拿起商品 (加速度 > 阈值)
          │
[0-30ms]  MCU 唤醒，绿灯闪
          │
[30-330ms] 广播 motion=1 (300ms)
          │
[330-3330ms] 尾随窗口等待 (3000ms)
          │
[3330-3400ms] 蓝灯闪，进入睡眠 (~70ms)
          │
[3400ms+] 深度睡眠，等待下次运动
```

**场景 2：连续晃动商品**
```
时间轴: 0ms ──────────────────────────────────────────────────────────► 

[0ms]     第一次运动
          │
[0-300ms] 广播中...
          │
[200ms]   第二次运动 → 重置广播计时器
          │
[200-500ms] 继续广播...
          │
[500ms]   进入尾随窗口
          │
[800ms]   第三次运动 → 重新广播，退出尾随窗口
          │
[800-1100ms] 广播中...
          │
... (如此循环，直到 3 秒内无运动)
```

### 参数对系统的影响

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         参数影响关系图                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   THRESHOLD (运动阈值)                                                   │
│   ├── 越小 → 越灵敏 → 误触发风险↑ → 电池消耗↑                             │
│   └── 越大 → 越迟钝 → 可能漏检 → 电池消耗↓                                │
│                                                                         │
│   TAIL_WINDOW (尾随窗口)                                                 │
│   ├── 越短 → 更省电 → 连续动作体验差 (每次都重新唤醒)                       │
│   └── 越长 → 更耗电 → 连续动作体验好 (合并为一次唤醒)                       │
│                                                                         │
│   TX_POWER (发射功率)                                                    │
│   ├── 越高 → 覆盖范围↑ → 电池消耗略↑                                      │
│   └── 越低 → 覆盖范围↓ → 电池消耗略↓                                      │
│                                                                         │
│   IMU ODR (采样率，固定 26Hz)                                             │
│   └── 平衡响应速度与功耗 (12.5Hz 太慢易漏检，52Hz 功耗略高)                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 默认参数值一览

| 参数 | 默认值 | 单位 | 作用位置 |
|------|--------|------|----------|
| THRESHOLD | 0x0A (~312mg) | mg | IMU 唤醒检测 |
| BROADCAST_DURATION | 300 | ms | 广播状态 |
| TAIL_WINDOW | 3000 | ms | 尾随窗口 |
| TX_POWER | +4 | dBm | BLE 发射 |
| IMU ODR | 26 | Hz | IMU 采样率 |

---

## 快速配置

编辑 `config.h`：

```c
#define SENSITIVITY_PRESET  2    // 0=高级, 1=高灵敏, 2=标准, 3=低灵敏
#define DEBUG_ENABLED  0         // 0=生产, 1=调试
```

| 预设 | 触发条件 | 适用场景 | 续航 (200次/天) |
|------|----------|----------|-----------------|
| 1 高灵敏 | 轻触即触发 | 小件/轻便商品 | ~6 个月 |
| 2 标准 | 正常拿起 | 大多数商品 | ~10 个月 |
| 3 低灵敏 | 需用力拿起 | 震动环境/重型商品 | ~12+ 个月 |
| 0 高级 | 自定义 | 需要微调的场景 | 取决于配置 |

### 高级模式 (SENSITIVITY_PRESET = 0)

当预设 1-3 无法满足需求时，设置 `SENSITIVITY_PRESET = 0` 并调整以下参数：

```c
#define SENSITIVITY_PRESET   0       // 启用高级模式

#define CUSTOM_THRESHOLD     0x0A    // 运动阈值 (0x02~0x3F)
#define CUSTOM_TAIL_WINDOW   3000    // 尾随窗口 (ms)
#define CUSTOM_TX_POWER      4       // 发射功率 (dBm)
```

**参数说明：**

| 参数 | 范围 | 说明 |
|------|------|------|
| CUSTOM_THRESHOLD | 0x02~0x3F | 越小越灵敏，公式: 阈值 = 值 × 31.25mg |
| CUSTOM_TAIL_WINDOW | 1000~10000 | 广播后等待时间(ms)，越长越耗电 |
| CUSTOM_TX_POWER | -40 ~ +4 | 发射功率(dBm)，越高覆盖越远但更耗电 |

---

## 功耗影响因素

### 触发频率（最主要因素）

| 每日触发次数 | CR2032 续航 |
|--------------|-------------|
| 50 次 | 1.5+ 年 |
| 200 次 | 8-12 个月 |
| 500 次 | 4-6 个月 |
| 1000 次 | 2-3 个月 |

> **关键**：误触发会显著缩短电池寿命。震动环境务必使用低灵敏度预设。

### 功耗状态

| 状态 | 电流 | 说明 |
|------|------|------|
| 深度睡眠 | < 5 µA | 99% 时间处于此状态 |
| BLE 广播 | ~3 mA | 每次触发约 300ms |
| 尾随窗口 | ~0.5 mA | 等待连续动作，最长 2-4 秒 |

### 环境因素

| 因素 | 影响 | 建议 |
|------|------|------|
| 低温 (<0°C) | 电池容量↓ 30-50% | 避免冷库环境 |
| 高温 (>45°C) | 电池寿命缩短 | 避免阳光直射 |
| 震动源附近 | 误触发↑ | 使用低灵敏度 |

---

## 通信质量影响因素

### 网关距离

| 距离 | 遮挡情况 | 信号质量 |
|------|----------|----------|
| < 5m | 无遮挡 | ★★★ 优秀 |
| 5-15m | 无遮挡 | ★★☆ 良好 |
| 5-10m | 有人/货架 | ★★☆ 良好 |
| > 15m | 任意 | ★☆☆ 较差 |
| 任意 | 金属遮挡 | ★☆☆ 较差 |

### 发射功率

| 预设 | TX Power | 覆盖范围 |
|------|----------|----------|
| 1, 2 | +4 dBm | ~30m（开阔）|
| 3 | 0 dBm | ~15m（省电）|

### 干扰源

| 干扰源 | 影响程度 | 建议 |
|--------|----------|------|
| WiFi 路由器 | 中 | 保持 >1m 距离 |
| 微波炉运行中 | 高 | 避免同时工作 |
| 金属货架 | 中 | 传感器朝向网关 |
| 密集 BLE 设备 | 低 | 通常可忽略 |

### 广播可靠性

固件已优化：
- 广播时长 300ms（足够网关扫描到）
- 快速广播间隔 20ms（提高被捕获概率）
- 尾随窗口合并连续动作（避免重复唤醒）

---

## 故障排查

### 传感器不触发
1. 检查电池（更换测试）
2. 尝试更高灵敏度预设
3. 观察 LED：绿色闪烁=正常启动

### 触发但网关收不到
1. 确认网关距离 < 15m
2. 检查金属遮挡
3. 启用 `DEBUG_ENABLED=1` 查看串口

### 误触发频繁
1. 切换到低灵敏度预设 (3)
2. 检查安装位置震动源
3. 确保传感器固定牢固

### LED 含义

| LED | 行为 | 时长 | 含义 |
|-----|------|------|------|
| 绿灯短闪 | 唤醒时 | 30ms | 检测到运动，MCU 启动 |
| 蓝灯短闪 | 睡眠前 | 50ms | 即将进入深度睡眠 |
| 蓝灯持续闪 | 启动时 | 500ms 循环 | IMU 初始化失败 |

---

## 电池更换

- **预期寿命**：6-12 个月（取决于触发频率）
- **更换后**：无需重新配对，MAC 地址不变
- **建议**：记录安装日期，定期批量更换

---

## 技术规格

| 项目 | 规格 |
|------|------|
| MCU | nRF52840 |
| IMU | LSM6DS3 (板载) |
| 协议 | BTHome v2 (0xFCD2) |
| 电池 | CR2032 (220mAh) |
| 睡眠功耗 | < 5 µA |
| 广播功耗 | ~3 mA |
| 工作温度 | -20°C ~ +60°C |

---

## 开发相关

### 编译环境

1. Arduino IDE + Seeed nRF52 开发板包
2. 依赖库：`Seeed Arduino LSM6DS3`

### 开发板选择

```
工具 → 开发板 → Seeed nRF52 Boards → Seeed XIAO nRF52840
```

### BTHome 数据格式

| 字段 | 值 | 说明 |
|------|-----|------|
| UUID | 0xFCD2 | BTHome 服务 |
| Device Info | 0x44 | 触发型设备 |
| Object ID | 0x21 | 二进制运动 |
| Value | 0x01 | 检测到运动 |
